<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Agent Comparison</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/diff@5/dist/diff.min.js"></script>
</head>
<body class="p-4 font-sans">
  <div id="app"></div>
  <script type="text/javascript">
    const { useState, useEffect } = React;

    function DiffText({ base, text }) {
      if (!base) return React.createElement('pre', { className: 'whitespace-pre-wrap' }, text);
      const lib = window.Diff || window.JsDiff;
      if (!lib) return React.createElement('pre', { className: 'whitespace-pre-wrap' }, text);
      const parts = lib.diffWords(base, text);
      return React.createElement('pre', { className: 'whitespace-pre-wrap' },
        parts.map((p, i) => React.createElement('span', {
          key: i,
          className: p.added ? 'bg-green-200' : p.removed ? 'bg-red-200 line-through' : ''
        }, p.value))
      );
    }

    function mean(values) {
      const valid = values.filter(v => typeof v === 'number');
      if (!valid.length) return 0;
      const sum = valid.reduce((a, b) => a + b, 0);
      return sum / valid.length;
    }

    function std(values, avg) {
      const valid = values.filter(v => typeof v === 'number');
      if (!valid.length) return 0;
      const variance = valid.reduce((acc, v) => acc + Math.pow(v - avg, 2), 0) / valid.length;
      return Math.sqrt(variance);
    }

    function detectAnomalies(logs, model = 'isolation_forest') {
      if (!Array.isArray(logs)) return [];
      const totals = logs.map(l => l && l.unperceived_score && typeof l.unperceived_score.total === 'number'
        ? l.unperceived_score.total
        : null);
      let flags;
      switch (model) {
        case 'one_class_svm':
          flags = totals.map(t => typeof t === 'number' && t < 0.3);
          break;
        case 'autoencoder':
          flags = totals.map(t => typeof t === 'number' && (t > 0.9 || t < 0.1));
          break;
        case 'isolation_forest':
        default:
          const avg = mean(totals);
          const sd = std(totals, avg);
          const high = avg + 2 * sd;
          const low = avg - 2 * sd;
          flags = totals.map(t => typeof t === 'number' && (t > high || t < low));
          break;
      }
      return logs.map((log, idx) => ({
        ...log,
        anomaly: Boolean(flags[idx])
      }));
    }

    function Dashboard() {
      const [rawLogs, setRawLogs] = useState([]);
      const [logs, setLogs] = useState([]);
      const [agentFilter, setAgentFilter] = useState('');
      const [modelFilter, setModelFilter] = useState('');
      const [selectedModel, setSelectedModel] = useState('isolation_forest');
      const [showAnomalyOnly, setShowAnomalyOnly] = useState(false);
      const [summary, setSummary] = useState({});

      useEffect(() => {
        fetch('/api/multi-agent-log')
          .then(r => r.json())
          .then(setRawLogs)
          .catch(err => console.error('Failed to load logs', err));
      }, []);

      useEffect(() => {
        setLogs(detectAnomalies(rawLogs, selectedModel));
      }, [rawLogs, selectedModel]);

      useEffect(() => {
        fetch('/api/unperceived-summary')
          .then(r => r.json())
          .then(setSummary)
          .catch(err => console.error('Failed to load unperceived summary', err));
      }, []);

      const agents = Array.from(new Set(logs.map(l => l.agent_name))).sort();
      const models = Array.from(new Set(logs.map(l => l.model))).sort();
      const summaryAgents = Array.from(new Set([...agents, ...Object.keys(summary)])).sort();

      const crashByAgent = {};
      const unpercByAgent = {};
      logs.forEach(l => {
        if (!l || !l.agent_name) return;
        if (l.crash_summary) {
          crashByAgent[l.agent_name] = l.crash_summary;
        }
        const up = l.unperceived_score && l.unperceived_score.total;
        if (typeof up === 'number') {
          unpercByAgent[l.agent_name] = up;
        }
      });

      const filtered = logs.filter(l =>
        (!agentFilter || l.agent_name === agentFilter) &&
        (!modelFilter || l.model === modelFilter) &&
        (!showAnomalyOnly || l.anomaly)
      );

      const anomalyCount = filtered.filter(l => l.anomaly).length;
      const totalCount = filtered.length;

      const groups = {};
      filtered.forEach(l => {
        groups[l.prompt] = groups[l.prompt] || [];
        groups[l.prompt].push(l);
      });

      const colorForScore = v => {
        if (typeof v !== 'number') return {};
        const clamped = Math.max(0, Math.min(1, v));
        const hue = 120 - clamped * 120; // 120=green, 0=red
        return { backgroundColor: `hsl(${hue}, 70%, 90%)` };
      };

      const tooltipFor = entry => {
        if (!entry || !entry.unperceived_score) return '';
        const up = entry.unperceived_score;
        const parts = [];
        if (typeof up.entropy_score === 'number') parts.push(`entropy=${up.entropy_score.toFixed(2)}`);
        if (typeof up.symbol_density === 'number') parts.push(`symbol=${up.symbol_density.toFixed(2)}`);
        if (typeof entry.repeat_score === 'number') parts.push(`repeat=${entry.repeat_score.toFixed(2)}`);
        if (typeof entry.void_score === 'number') parts.push(`void=${entry.void_score.toFixed(2)}`);
        if (typeof entry.duplicationRate === 'number') parts.push(`dup=${entry.duplicationRate.toFixed(2)}`);
        if (typeof entry.rhythm_score === 'number') parts.push(`rhythm=${entry.rhythm_score.toFixed(2)}`);
        return parts.join(', ');
      };

      return React.createElement('div', { className: 'space-y-6' },
        React.createElement('div', { className: 'flex space-x-4 mb-4 items-center' },
          React.createElement('select', {
            className: 'border px-2 py-1',
            value: agentFilter,
            onChange: e => setAgentFilter(e.target.value)
          },
            React.createElement('option', { value: '' }, 'All Agents'),
            ...agents.map(a => React.createElement('option', { key: a, value: a }, a))
          ),
          React.createElement('select', {
            className: 'border px-2 py-1',
            value: modelFilter,
            onChange: e => setModelFilter(e.target.value)
          },
            React.createElement('option', { value: '' }, 'All Models'),
            ...models.map(m => React.createElement('option', { key: m, value: m }, m))
          ),
          React.createElement('label', { className: 'flex items-center space-x-1' },
            React.createElement('span', null, 'Select Anomaly Detection Model:'),
            React.createElement('select', {
              className: 'border px-2 py-1',
              value: selectedModel,
              onChange: e => setSelectedModel(e.target.value)
            },
              React.createElement('option', { value: 'isolation_forest' }, 'isolation_forest'),
              React.createElement('option', { value: 'autoencoder' }, 'autoencoder'),
              React.createElement('option', { value: 'one_class_svm' }, 'one_class_svm')
            )
          ),
          React.createElement('label', { className: 'flex items-center space-x-1' },
            React.createElement('input', {
              type: 'checkbox',
              className: 'form-checkbox',
              checked: showAnomalyOnly,
              onChange: e => setShowAnomalyOnly(e.target.checked)
            }),
            React.createElement('span', null, 'Show Anomalies Only')
          ),
          React.createElement('div', { className: 'ml-auto text-sm' }, `Anomalies ${anomalyCount} / ${totalCount}`)
        ),
        React.createElement('table', { className: 'min-w-full text-sm mb-4 border' },
          React.createElement('thead', null,
            React.createElement('tr', null,
              React.createElement('th', { className: 'border px-2 py-1' }, 'Agent Name'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Unperceived Score')
            )
          ),
          React.createElement('tbody', null,
            summaryAgents.map(agent => {
              const val = summary.hasOwnProperty(agent) ? summary[agent] : null;
              const display = typeof val === 'number' ? val.toFixed(2) : '--';
              return React.createElement('tr', { key: agent },
                React.createElement('td', { className: 'border px-2 py-1' }, agent),
                React.createElement('td', { className: 'border px-2 py-1 text-right', style: colorForScore(val) }, display)
              );
            })
          )
        ),
        React.createElement('table', { className: 'min-w-full text-sm mb-4 border' },
          React.createElement('thead', null,
            React.createElement('tr', null,
              React.createElement('th', { className: 'border px-2 py-1' }, 'Agent'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Normal'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Warning'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Critical'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Score'),
              React.createElement('th', { className: 'border px-2 py-1' }, 'Unperceived Score')
            )
          ),
          React.createElement('tbody', null,
            Object.keys(crashByAgent).sort().map(agent => {
              const cs = crashByAgent[agent] || {};
              const fmt = v => (typeof v === 'number' ? v : '-');
              const score = typeof cs.score === 'number' ? cs.score.toFixed(1) : '-';
              const upScore = unpercByAgent.hasOwnProperty(agent) ? unpercByAgent[agent] : null;
              const upDisplay = typeof upScore === 'number' ? upScore.toFixed(1) : '-';
              return React.createElement('tr', { key: agent },
                React.createElement('td', { className: 'border px-2 py-1' }, agent),
                React.createElement('td', { className: 'border px-2 py-1 text-right' }, fmt(cs.normal)),
                React.createElement('td', { className: 'border px-2 py-1 text-right' }, fmt(cs.warning)),
                React.createElement('td', { className: 'border px-2 py-1 text-right' }, fmt(cs.critical)),
                React.createElement('td', { className: 'border px-2 py-1 text-right' }, score),
                React.createElement('td', { className: 'border px-2 py-1 text-right', style: colorForScore(upScore) }, upDisplay)
              );
            })
          )
        ),
        Object.keys(groups).map(prompt => {
          const entries = groups[prompt];
          const base = entries[0]?.response || '';
          return React.createElement('div', { key: prompt, className: 'border rounded p-4 space-y-4' },
            React.createElement('div', { className: 'font-semibold' }, prompt),
            React.createElement('div', { className: 'grid md:grid-cols-2 gap-4' },
              entries.map((e, idx) => React.createElement('div', {
                key: idx,
                className: `border rounded p-3 space-y-2 bg-gray-50${e.anomaly ? ' ring-2 ring-red-500 bg-red-100' : ''}`,
                style: colorForScore(e.unperceived_score && e.unperceived_score.total),
                title: tooltipFor(e)
              },
                React.createElement('div', { className: 'font-medium' }, e.agent_name),
                React.createElement('div', { className: 'text-sm text-gray-600' }, `Model: ${e.model}`),
                React.createElement('div', { className: 'text-sm text-gray-600' }, `Latency: ${e.latency_ms} ms`),
                React.createElement('div', { className: 'text-sm text-gray-600' }, `Cost: $${e.cost_usd}`),
                React.createElement('div', { className: 'text-sm text-gray-600' }, `Unperc Score: ${e.unperceived_score && typeof e.unperceived_score.total === 'number' ? e.unperceived_score.total.toFixed(3) : '-'}`),
                e.anomaly && React.createElement('span', { className: 'text-xs font-semibold text-red-600' }, 'Anomaly'),
                React.createElement('div', { className: 'max-h-60 overflow-auto text-sm border-t pt-2' },
                  React.createElement(DiffText, { base: idx === 0 ? null : base, text: e.response })
                )
              ))
            )
          );
        })
      );
    }

    ReactDOM.render(React.createElement(Dashboard), document.getElementById('app'));
  </script>
</body>
</html>
